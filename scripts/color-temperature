#!/usr/bin/env sh

# Cache
cache_dir=$SCRIPT_CACHE_DIR
cache_mode=$cache_dir/mode

if [ ! -d "$cache_dir" ]; then
    mkdir -p "$cache_dir"
    echo "auto" > $cache_mode
fi


_get_status() {
    enable=0
    if [ -n "$(pgrep wlsunset)" ]; then
        enable=1
    fi

    mode=$(cat $cache_mode)
    printf '{'
    printf '"enable": %s,' $enable
    printf '"mode": "%s"' $mode
    printf '}\n'
}

_start_color_adjust() {
    wlsunset -l $1 -L $2 &

    # Set the previous mode
    mode=$(cat $cache_mode)
    if [ "$mode" = "auto" ]; then
        # does nothing
        :
    elif [ "$mode" = "high" ]; then
        pkill -USR1 wlsunset
    else
        # Go to high
        pkill -USR1 wlsunset

        # Finally go to low
        pkill -USR1 wlsunset
    fi
}

_update_mode_to() {
    target="$1"
    mode=$(cat "$cache_mode")

    [ "$mode" = "$target" ] && return 0

    case "$mode:$target" in
        auto:high | high:low | low:auto)
            count=1
            ;;
        auto:low | low:high | high:auto)
            count=2
            ;;
        *)
            error "Invalid mode transition: $mode â†’ $target"
            return 1
            ;;
    esac

    i=1
    while [ $i -le $count ]; do
        pkill -USR1 wlsunset
        i=$((i + 1))
    done

    echo "$target" > "$cache_mode"
}


cmd=$1
case $cmd in
    status)
        _get_status
        ;;

    run)
        if [ $# -gt 1 ]; then
            error "Too many arguments!"
            exit 1
        fi

        if [ -z "$(pgrep wlsunset)" ]; then
            lat=$(sh $root/_scripter location latitude)
            lon=$(sh $root/_scripter location longitude)

            trap "pkill wlsunset; exit" $SIGINT $SIGTERM

            _start_color_adjust $lat $lon
            while true; do
                # Restart wlsunset if stopped
                if [ -z "$(pgrep wlsunset)" ]; then
                    lat=$(sh $root/_scripter location latitude)
                    lon=$(sh $root/_scripter location longitude)

                    _start_color_adjust $lat $lon
                fi

                sleep 30

                # Check for location changes
                cur_lat=$(sh $root/_scripter location latitude)
                cur_lon=$(sh $root/_scripter location longitude)
                if [ "$cur_lat" != "$lat" -o "$cur_lon" != "$lon" ]; then
                    lat=$cur_lat
                    lon=$cur_lon

                    # Restart wlsunset with new location coordinates
                    pkill wlsunset
                    _start_color_adjust $lat $lon
                fi
            done
        fi
        ;;

    set)
        if [ $# -eq 1 ]; then
            error "Expected <mode> given 0 arguments!"
            exit 1
        fi

        subcmd=$2
        case $subcmd in
            auto | high | low)
                if [ $# -gt 2 ]; then
                    error "Too many arguments!"
                    exit 1
                fi

                _update_mode_to $subcmd
                ;;

            *)
                error "Unknown mode '$subcmd'!"
                exit 1
                ;;
        esac
        ;;

    cycle)
        if [ $# -gt 1 ]; then
            error "Too many arguments!"
            exit 1
        fi

        pkill -USR1 wlsunset

        mode=$(cat $cache_mode)
        if [ "$mode" = "auto" ]; then
            echo "high" > $cache_mode
        elif [ "$mode" = "high" ]; then
            echo "low" > $cache_mode
        else
            echo "auto" > $cache_mode
        fi
        ;;

    *)
        error "Unknown command '$cmd'!"
        exit 1
        ;;
esac

